<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Kanban Nuvem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FullCalendar CSS e JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <style>
        .column-height { min-height: calc(100vh - 350px); }
        .modal-active { display: flex !important; }
        #loading-overlay {
            position: fixed; inset: 0; background: white;
            display: flex; align-items: center; justify-content: center;
            z-index: 100; transition: opacity 0.5s;
        }
        /* Estiliza√ß√£o Customizada do Calend√°rio */
        .fc { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .fc-header-toolbar { margin-bottom: 1.5em !important; }
        .fc-event { cursor: pointer; padding: 2px 5px; font-size: 0.85em; border: none !important; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <div id="loading-overlay">
        <div class="flex flex-col items-center gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p id="loading-text" class="text-slate-500 font-medium italic">Sincronizando Firestore...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="mb-6 flex flex-col gap-4">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Meu Kanban Nuvem ‚òÅÔ∏è</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></span>
                        <p id="status-text" class="text-xs text-slate-500 font-medium">Desconectado</p>
                    </div>
                </div>
                <div id="user-info" class="text-right text-[10px] text-slate-400 font-mono"></div>
            </div>

            <!-- Navega√ß√£o por Abas -->
            <div class="flex border-b border-slate-200 mt-4">
                <button onclick="switchTab('board')" id="tab-board" class="px-6 py-2 font-bold transition-all tab-active">Visualiza√ß√£o em Colunas</button>
                <button onclick="switchTab('calendar')" id="tab-calendar" class="px-6 py-2 font-bold transition-all text-slate-400 hover:text-slate-600">Calend√°rio Mensal</button>
            </div>
            
            <!-- Formul√°rio (Sempre vis√≠vel ou opcional) -->
            <div id="task-form" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mt-4">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="flex flex-col gap-1 md:col-span-2">
                        <label class="text-xs font-semibold uppercase text-slate-500">Tarefa</label>
                        <input type="text" id="taskInput" placeholder="O que precisa ser feito?" class="border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none w-full">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-xs font-semibold uppercase text-slate-500">Data Limite</label>
                        <input type="date" id="dateInput" class="border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex gap-2">
                        <button id="addBtn" onclick="saveTask()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Adicionar</button>
                        <button id="cancelBtn" onclick="clearForm()" class="hidden bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    </div>
                    <div class="flex flex-col gap-1 md:col-span-4 mt-2">
                        <textarea id="descInput" rows="2" placeholder="Descri√ß√£o... (Cole imagem com Ctrl+V)" class="border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none w-full resize-none"></textarea>
                        <div id="imagePreviewContainer" class="hidden mt-2 relative w-24 h-24 border rounded overflow-hidden">
                            <img id="imagePreview" src="" class="w-full h-full object-cover">
                            <button onclick="removeImageFromForm()" class="absolute top-0 right-0 bg-red-500 text-white p-1 text-[10px]">X</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conte√∫do das Abas -->
        <main>
            <!-- Vis√£o Kanban -->
            <div id="view-board" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="flex flex-col gap-4">
                    <div class="flex justify-between px-2 text-slate-500 uppercase text-xs font-bold tracking-widest">A Fazer <span id="count-todo">0</span></div>
                    <div id="todo" class="task-list column-height bg-slate-100 rounded-xl p-3 border-2 border-transparent" ondragover="allowDrop(event)" ondrop="drop(event, 'todo')"></div>
                </div>
                <div class="flex flex-col gap-4">
                    <div class="flex justify-between px-2 text-blue-600 uppercase text-xs font-bold tracking-widest">Fazendo <span id="count-doing">0</span></div>
                    <div id="doing" class="task-list column-height bg-blue-50/50 rounded-xl p-3 border-2 border-transparent" ondragover="allowDrop(event)" ondrop="drop(event, 'doing')"></div>
                </div>
                <div class="flex flex-col gap-4">
                    <div class="flex justify-between px-2 text-emerald-600 uppercase text-xs font-bold tracking-widest">Conclu√≠do <span id="count-done">0</span></div>
                    <div id="done" class="task-list column-height bg-emerald-50/50 rounded-xl p-3 border-2 border-transparent" ondragover="allowDrop(event)" ondrop="drop(event, 'done')"></div>
                </div>
            </div>

            <!-- Vis√£o Calend√°rio -->
            <div id="view-calendar" class="hidden">
                <div id="calendar"></div>
            </div>
        </main>
    </div>

    <!-- Modal Detalhes -->
    <div id="taskModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm" onclick="closeModal(event)">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6 border-b flex justify-between items-start">
                <div><h2 id="modalTitle" class="text-2xl font-bold"></h2><p id="modalDate" class="text-sm text-slate-500 mt-1"></p></div>
                <button onclick="closeModal()" class="text-slate-400">‚úñ</button>
            </div>
            <div class="p-6">
                <p id="modalDesc" class="text-slate-700 whitespace-pre-wrap mb-4"></p>
                <div id="modalImageContainer" class="hidden border rounded-xl overflow-hidden"><img id="modalImage" class="w-full"></div>
            </div>
            <div class="p-6 bg-slate-50 flex justify-end gap-3">
                <button id="modalEditBtn" class="px-4 py-2 text-blue-600 font-bold">Editar</button>
                <button onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-lg font-bold">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, updateDoc, addDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAIR5A2KX12zQBeOkNrSmACmsi14TeWfFE",
            authDomain: "kabam-73cd9.firebaseapp.com",
            projectId: "kabam-73cd9",
            storageBucket: "kabam-73cd9.firebasestorage.app",
            messagingSenderId: "681366929009",
            appId: "1:681366929009:web:fca50d8b1a0d637097a5d0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'meu-kanban-pessoal-v1';

        let user = null;
        let tasks = [];
        let currentPastedImage = null;
        let draggedTaskId = null;
        let calendar = null;

        // Controle de Abas
        window.switchTab = (view) => {
            const board = document.getElementById('view-board');
            const cal = document.getElementById('view-calendar');
            const tabB = document.getElementById('tab-board');
            const tabC = document.getElementById('tab-calendar');

            if (view === 'board') {
                board.classList.remove('hidden');
                cal.classList.add('hidden');
                tabB.classList.add('tab-active'); tabB.classList.remove('text-slate-400');
                tabC.classList.remove('tab-active'); tabC.classList.add('text-slate-400');
            } else {
                board.classList.add('hidden');
                cal.classList.remove('hidden');
                tabC.classList.add('tab-active'); tabC.classList.remove('text-slate-400');
                tabB.classList.remove('tab-active'); tabB.classList.add('text-slate-400');
                if (calendar) calendar.render(); // Re-renderiza para evitar bugs de tamanho
            }
        };

        // Inicializar Calend√°rio
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                buttonText: { today: 'Hoje', month: 'M√™s', week: 'Semana' },
                events: getCalendarEvents(),
                eventClick: (info) => window.openModal(info.event.id)
            });
            calendar.render();
        }

        function getCalendarEvents() {
            const colors = { todo: '#94a3b8', doing: '#2563eb', done: '#10b981' };
            return tasks
                .filter(t => t.date && t.date !== 'Sem data')
                .map(t => ({
                    id: t.id,
                    title: t.text,
                    start: t.date,
                    backgroundColor: colors[t.status],
                    borderColor: colors[t.status]
                }));
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-emerald-500";
                document.getElementById('status-text').innerText = "Conectado ao Firestore";
                document.getElementById('user-info').innerText = `ID: ${user.uid.substring(0,8)}`;
                subscribeToTasks();
                const loader = document.getElementById('loading-overlay');
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        });

        signInAnonymously(auth).catch(console.error);

        function subscribeToTasks() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
            onSnapshot(q, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks();
                if (!calendar) initCalendar();
                else {
                    calendar.removeAllEvents();
                    calendar.addEventSource(getCalendarEvents());
                }
            });
        }

        // Fun√ß√µes de A√ß√£o
        window.saveTask = async () => {
            const input = document.getElementById('taskInput');
            const dateInput = document.getElementById('dateInput');
            const descInput = document.getElementById('descInput');
            const editId = document.getElementById('editId').value;
            if (!input.value.trim()) return;

            const data = {
                text: input.value, description: descInput.value,
                date: dateInput.value || 'Sem data', image: currentPastedImage,
                updatedAt: Date.now()
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', editId), data);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), { 
                        ...data, status: 'todo', createdAt: Date.now() 
                    });
                }
                window.clearForm();
            } catch (e) { alert("Erro ao salvar! Verifique as regras do Firestore."); }
        };

        window.editTask = (id) => {
            const t = tasks.find(x => x.id === id);
            document.getElementById('taskInput').value = t.text;
            document.getElementById('dateInput').value = t.date === 'Sem data' ? '' : t.date;
            document.getElementById('descInput').value = t.description || '';
            document.getElementById('editId').value = t.id;
            if (t.image) {
                currentPastedImage = t.image;
                document.getElementById('imagePreview').src = t.image;
                document.getElementById('imagePreviewContainer').classList.remove('hidden');
            }
            document.getElementById('addBtn').innerText = 'Guardar';
            document.getElementById('cancelBtn').classList.remove('hidden');
            window.closeModal();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.deleteTask = async (id, e) => {
            if (e) e.stopPropagation();
            if (confirm("Apagar tarefa?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id));
        };

        // Drag & Drop
        window.allowDrop = (e) => e.preventDefault();
        window.drag = (id) => draggedTaskId = id;
        window.drop = async (e, status) => {
            e.preventDefault();
            if (draggedTaskId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', draggedTaskId), { status });
        };

        window.clearForm = () => {
            document.getElementById('taskInput').value = '';
            document.getElementById('dateInput').value = '';
            document.getElementById('descInput').value = '';
            document.getElementById('editId').value = '';
            window.removeImageFromForm();
            document.getElementById('addBtn').innerText = 'Adicionar';
            document.getElementById('cancelBtn').classList.add('hidden');
        };

        window.removeImageFromForm = () => {
            currentPastedImage = null;
            document.getElementById('imagePreviewContainer').classList.add('hidden');
        };

        window.openModal = (id) => {
            const t = tasks.find(x => x.id === id);
            document.getElementById('modalTitle').innerText = t.text;
            document.getElementById('modalDate').innerText = `üìÖ ${t.date}`;
            document.getElementById('modalDesc').innerText = t.description || 'Sem descri√ß√£o.';
            const imgC = document.getElementById('modalImageContainer');
            if (t.image) { document.getElementById('modalImage').src = t.image; imgC.classList.remove('hidden'); }
            else imgC.classList.add('hidden');
            document.getElementById('modalEditBtn').onclick = () => window.editTask(t.id);
            document.getElementById('taskModal').classList.add('modal-active');
        };

        window.closeModal = () => document.getElementById('taskModal').classList.remove('modal-active');

        // Paste Image
        document.addEventListener('paste', (e) => {
            const item = Array.from(e.clipboardData.items).find(x => x.type.indexOf('image') !== -1);
            if (item) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    currentPastedImage = ev.target.result;
                    document.getElementById('imagePreview').src = currentPastedImage;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                };
                reader.readAsDataURL(item.getAsFile());
            }
        });

        function renderTasks() {
            const cols = { todo: document.getElementById('todo'), doing: document.getElementById('doing'), done: document.getElementById('done') };
            const counts = { todo: 0, doing: 0, done: 0 };
            Object.values(cols).forEach(c => c.innerHTML = '');

            tasks.sort((a,b) => b.createdAt - a.createdAt).forEach(t => {
                counts[t.status]++;
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-lg shadow-sm border border-slate-200 mb-3 cursor-pointer group';
                card.draggable = true;
                card.ondragstart = () => window.drag(t.id);
                card.onclick = () => window.openModal(t.id);
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-sm">${t.text}</h3>
                        <button onclick="window.deleteTask('${t.id}', event)" class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500">‚úñ</button>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-2 font-bold uppercase">üìÖ ${t.date}</div>
                `;
                cols[t.status].appendChild(card);
            });

            document.getElementById('count-todo').innerText = counts.todo;
            document.getElementById('count-doing').innerText = counts.doing;
            document.getElementById('count-done').innerText = counts.done;
        }
    </script>
</body>
</html>