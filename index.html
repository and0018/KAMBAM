<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Kanban Nuvem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .column-height {
            min-height: calc(100vh - 250px);
        }
        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .drop-zone-active {
            background-color: rgba(0, 0, 0, 0.05);
            border: 2px dashed #cbd5e1;
        }
        .modal-active {
            display: flex !important;
        }
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <!-- Overlay de Carregamento -->
    <div id="loading-overlay">
        <div class="flex flex-col items-center gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="text-slate-500 font-medium italic">Sincronizando com a nuvem...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="mb-8 flex flex-col gap-4">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Meu Kanban Nuvem ‚òÅÔ∏è</h1>
                    <p class="text-slate-500">Tarefas sincronizadas em qualquer dispositivo.</p>
                </div>
                <div id="user-info" class="text-right text-[10px] text-slate-400 font-mono"></div>
            </div>
            
            <!-- Formul√°rio de Tarefa -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="flex flex-col gap-1 md:col-span-2">
                        <label class="text-xs font-semibold uppercase text-slate-500">T√≠tulo da Tarefa</label>
                        <input type="text" id="taskInput" placeholder="O que precisa ser feito?" 
                               class="border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none w-full">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-xs font-semibold uppercase text-slate-500">Data Limite</label>
                        <input type="date" id="dateInput" 
                               class="border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex gap-2">
                        <button id="addBtn" onclick="saveTask()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Adicionar
                        </button>
                        <button id="cancelBtn" onclick="clearForm()" class="hidden bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-2 px-4 rounded-lg transition-colors">
                            Cancelar
                        </button>
                    </div>
                    <div class="flex flex-col gap-1 md:col-span-4 mt-2">
                        <label class="text-xs font-semibold uppercase text-slate-500">Descri√ß√£o (Ctrl+V para colar imagem)</label>
                        <textarea id="descInput" rows="2" placeholder="Descreva a atividade... Cole imagens aqui com Ctrl+V" 
                                  class="border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none w-full resize-none"></textarea>
                        <div id="imagePreviewContainer" class="hidden mt-2 relative w-32 h-32 border rounded overflow-hidden shadow-inner bg-slate-50">
                            <img id="imagePreview" src="" class="w-full h-full object-cover">
                            <button onclick="removeImageFromForm()" class="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-bl text-xs">X</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Board -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between px-2 text-slate-500">
                    <h2 class="font-bold flex items-center gap-2 text-slate-600">A Fazer</h2>
                    <span id="count-todo" class="bg-slate-200 text-xs px-2 py-1 rounded-full font-medium">0</span>
                </div>
                <div id="todo" class="task-list column-height bg-slate-100 rounded-xl p-3 border-2 border-transparent" 
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'todo')"></div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between px-2 text-blue-600">
                    <h2 class="font-bold flex items-center gap-2">Fazendo</h2>
                    <span id="count-doing" class="bg-blue-100 text-xs px-2 py-1 rounded-full font-medium">0</span>
                </div>
                <div id="doing" class="task-list column-height bg-blue-50/50 rounded-xl p-3 border-2 border-transparent" 
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'doing')"></div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between px-2 text-emerald-600">
                    <h2 class="font-bold flex items-center gap-2">Conclu√≠do</h2>
                    <span id="count-done" class="bg-emerald-100 text-xs px-2 py-1 rounded-full font-medium">0</span>
                </div>
                <div id="done" class="task-list column-height bg-emerald-50/50 rounded-xl p-3 border-2 border-transparent" 
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'done')"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Visualiza√ß√£o -->
    <div id="taskModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm" onclick="closeModal(event)">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-slate-100 flex justify-between items-start">
                <div>
                    <h2 id="modalTitle" class="text-2xl font-bold text-slate-900"></h2>
                    <p id="modalDate" class="text-sm text-slate-500 mt-1 font-semibold uppercase tracking-wider"></p>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Descri√ß√£o</h3>
                    <p id="modalDesc" class="text-slate-700 whitespace-pre-wrap leading-relaxed"></p>
                </div>
                <div id="modalImageContainer" class="hidden border rounded-xl overflow-hidden bg-slate-50">
                    <img id="modalImage" src="" class="w-full h-auto">
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <button id="modalEditBtn" class="px-4 py-2 text-blue-600 font-bold hover:bg-blue-50 rounded-lg transition-colors">Editar</button>
                <button onclick="closeModal()" class="px-4 py-2 bg-slate-200 text-slate-700 font-bold rounded-lg hover:bg-slate-300 transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, updateDoc, addDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Credenciais do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAIR5A2KX12zQBeOkNrSmACmsi14TeWfFE",
            authDomain: "kabam-73cd9.firebaseapp.com",
            projectId: "kabam-73cd9",
            storageBucket: "kabam-73cd9.firebasestorage.app",
            messagingSenderId: "681366929009",
            appId: "1:681366929009:web:fca50d8b1a0d637097a5d0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // ID √∫nico para o seu Kanban
        const appId = 'meu-kanban-pessoal-v1';

        let user = null;
        let tasks = [];
        let currentPastedImage = null;

        // Login An√≥nimo para sincroniza√ß√£o entre dispositivos
        const login = async () => {
            try {
                // Garantir que n√£o tentamos usar tokens inv√°lidos do ambiente
                await signInAnonymously(auth);
            } catch (err) {
                console.error("Erro na autentica√ß√£o:", err);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                document.getElementById('user-info').innerText = `CONECTADO: ${user.uid.substring(0,8)}...`;
                subscribeToTasks();
                
                const loader = document.getElementById('loading-overlay');
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        });

        login();

        function subscribeToTasks() {
            if (!user) return;
            // Caminho seguindo a regra /artifacts/{appId}/public/data/{collectionName}
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
            
            onSnapshot(q, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks();
            }, (error) => {
                console.error("Erro no Firestore:", error);
            });
        }

        // Suporte a Imagem via Paste
        document.addEventListener('paste', function(e) {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        currentPastedImage = event.target.result;
                        document.getElementById('imagePreview').src = currentPastedImage;
                        document.getElementById('imagePreviewContainer').classList.remove('hidden');
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });

        window.removeImageFromForm = () => {
            currentPastedImage = null;
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('imagePreview').src = '';
        };

        window.saveTask = async () => {
            if (!user) return;
            const input = document.getElementById('taskInput');
            const dateInput = document.getElementById('dateInput');
            const descInput = document.getElementById('descInput');
            const editId = document.getElementById('editId').value;

            if (!input.value.trim()) return;

            const taskData = {
                text: input.value,
                description: descInput.value,
                date: dateInput.value || 'Sem data',
                image: currentPastedImage || null,
                updatedAt: Date.now()
            };

            try {
                if (editId) {
                    const taskRef = doc(db, 'artifacts', appId, 'public', 'data', 'tasks', editId);
                    await updateDoc(taskRef, taskData);
                } else {
                    const tasksCol = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
                    await addDoc(tasksCol, { 
                        ...taskData, 
                        status: 'todo', 
                        createdAt: Date.now() 
                    });
                }
                window.clearForm();
            } catch (err) {
                console.error(err);
                alert("Erro ao gravar dados na nuvem.");
            }
        };

        window.editTask = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            document.getElementById('taskInput').value = task.text;
            document.getElementById('dateInput').value = task.date === 'Sem data' ? '' : task.date;
            document.getElementById('descInput').value = task.description || '';
            document.getElementById('editId').value = task.id;
            if (task.image) {
                currentPastedImage = task.image;
                document.getElementById('imagePreview').src = task.image;
                document.getElementById('imagePreviewContainer').classList.remove('hidden');
            } else {
                window.removeImageFromForm();
            }
            document.getElementById('addBtn').innerText = 'Guardar Altera√ß√£o';
            document.getElementById('cancelBtn').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            window.closeModal();
        };

        window.openModal = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            document.getElementById('modalTitle').innerText = task.text;
            document.getElementById('modalDate').innerText = `üìÖ ${task.date.split('-').reverse().join('/')}`;
            document.getElementById('modalDesc').innerText = task.description || 'Sem descri√ß√£o.';
            const imgContainer = document.getElementById('modalImageContainer');
            const img = document.getElementById('modalImage');
            if (task.image) {
                img.src = task.image;
                imgContainer.classList.remove('hidden');
            } else {
                imgContainer.classList.add('hidden');
            }
            document.getElementById('modalEditBtn').onclick = () => window.editTask(task.id);
            document.getElementById('taskModal').classList.add('modal-active');
        };

        window.closeModal = (e) => {
            if (e && e.target !== e.currentTarget && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'svg') return;
            document.getElementById('taskModal').classList.remove('modal-active');
        };

        window.clearForm = () => {
            document.getElementById('taskInput').value = '';
            document.getElementById('dateInput').value = '';
            document.getElementById('descInput').value = '';
            document.getElementById('editId').value = '';
            window.removeImageFromForm();
            document.getElementById('addBtn').innerText = 'Adicionar';
            document.getElementById('cancelBtn').classList.add('hidden');
        };

        window.deleteTask = async (id, event) => {
            if (event) event.stopPropagation();
            if (!confirm("Eliminar esta tarefa permanentemente?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id));
            } catch (err) { console.error(err); }
        };

        // Drag and Drop
        let draggedTaskId = null;
        window.handleDragStart = (id) => { draggedTaskId = id; };
        window.handleDragOver = (e) => { e.preventDefault(); e.currentTarget.classList.add('drop-zone-active'); };
        window.handleDragLeave = (e) => e.currentTarget.classList.remove('drop-zone-active');
        window.handleDrop = async (e, status) => {
            e.preventDefault();
            e.currentTarget.classList.remove('drop-zone-active');
            if (!draggedTaskId) return;
            try {
                const taskRef = doc(db, 'artifacts', appId, 'public', 'data', 'tasks', draggedTaskId);
                await updateDoc(taskRef, { status });
            } catch (err) { console.error(err); }
        };

        function renderTasks() {
            const columns = {
                todo: document.getElementById('todo'),
                doing: document.getElementById('doing'),
                done: document.getElementById('done')
            };
            Object.values(columns).forEach(col => col.innerHTML = '');
            const counts = { todo: 0, doing: 0, done: 0 };

            const sortedTasks = [...tasks].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

            sortedTasks.forEach(task => {
                counts[task.status]++;
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm border border-slate-200 mb-3 cursor-pointer hover:shadow-md transition-all overflow-hidden relative group';
                card.draggable = true;
                card.ondragstart = () => window.handleDragStart(task.id);
                card.onclick = () => window.openModal(task.id);

                const isOverdue = task.date !== 'Sem data' && new Date(task.date) < new Date().setHours(0,0,0,0) && task.status !== 'done';

                card.innerHTML = `
                    ${task.image ? `<img src="${task.image}" class="w-full h-20 object-cover opacity-90">` : ''}
                    <div class="p-3">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-sm text-slate-800 line-clamp-2">${task.text}</h3>
                            <button onclick="window.deleteTask('${task.id}', event)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-[9px] font-bold uppercase ${isOverdue ? 'text-red-500' : 'text-slate-400'}">
                                üìÖ ${task.date !== 'Sem data' ? task.date.split('-').reverse().join('/') : 'Sem data'}
                            </span>
                        </div>
                    </div>
                `;
                columns[task.status].appendChild(card);
            });

            document.getElementById('count-todo').innerText = counts.todo;
            document.getElementById('count-doing').innerText = counts.doing;
            document.getElementById('count-done').innerText = counts.done;
        }
    </script>
</body>
</html>